# 自动更新系统

## 名词解释

1. Animation：番剧，一般对应一个季度。
2. Collection：集合。只有汉化组，画质，字幕语言和类型都相同的资源才能算入一个集合
3. Resource：单个资源，一般对应一个下载链接，但是内部可能是多资源形式
4. Mission：收集任务，追踪一个集合的更新状况。
5. Pinning: 绑定任务，固定一个番剧。番剧被固定后系统会在番剧开播后从Source中寻找相关资源，如果出现达到预期的集合就会自动创建一个Mission，同时结束Pinning任务。
6. Strategy：绑定策略，用于控制Pinning如何选择合适的集合创建任务。

## 需求

1. 用户在番剧还没有正式发布的时候决定好更新策略，当番剧发布后系统自动根据策略选择最优的汉化组作品作为默认收集作品添加到收集列表内。
2. 一个番剧可以被收集多次，相同收集计划需要：汉化组，画质，字幕类型都相同。
3. 用户要能够查看更新日志

## 模块分解

### 控制部分

#### 手动选择器（manual）

manual主要剧接收用户方传来的请求床架mission给manager。

#### 绑定选择器(Pinner)

Pinner用来管理所有Pinning，通过后者提供的信息选择出合适的集合创建任务。

提供系统需要进行追踪的番剧名称和BangumiId。支持grpc外部订阅源和bangumi-data导入。pinner主要是用来进行选择collection的，在provider可以提供多个番剧的情况下会选择出做好的collection。

#### 控制器（manager）

控制器管理所有的收集任务。外部传入Mission信息后，控制器会计算当前时间期望的集数。如果没有达到预期控制器会循环从Provider中查找最新资源，直到达到预期。如果当前收录资源集数与预期相同，则等待下一次更新放出时间。如果当前收录集数已经达到创建任务时提供的总集数，任务将会被标记为完成并退出。

controller支持一下几种操作：

1. Skip：调整本周的期望值为上周的期望值（注意这种情况会持续性影响之后的期望值，只有在番剧停播的时候才应该使用skip）
2. Cancel: 
3. Stop：暂时锁定状态，不进行更新操作，直到状态被解除
4. Start：解除锁定状态，重新开始更新。
5. Terminate：直接结束任务，controller将不会再更新集合，同时删除之前所有该任务的日志记录和资源信息。

#### 事件感知器(Subscriber)

获取感知所有系统中正在发生的事情，支持一下事件：

1. PinningFinish：当一个绑定任务找到合适的集合，创建完任务后产生。
2. MissionUpdated：当一个更新任务更新完成时触发。
3. MissionFinish：当一个更新任务完成且退出时触发。
4. MissionUpdating：当一个任务转变为需要更新的时候触发。
5. MissionUpdateFaild：当一个任务更新失败时触发。
6. MissionCreated：当一个任务创建的时候触发。

系统的主要流程还是在收集环节，具体的下载任务通过subscriber的形式完成。

### 数据部分

#### 文件数据源(Source)

提供文件资源数据。传入文件名，模糊查找与之相关的文件信息并返回。主要实现有：

1. 动漫花园Rss

#### 数据清洗器(Parser)

从资源名中解析出有效的数据，如字幕组，视屏码率外挂情况等。主要实现有

1. Default（默认解析器）
2. Specific（针对汉化组的解析器）

#### 番剧信息源(Provider)

提供番剧信息查找获取的功能。支持按季度查找番剧，按名称模糊查找番剧，按id查找番剧。主要实现有

1. BangumiData（静态实现）
2. BangumiAPI（动态实现）

## 工作流程

1. manager接收来自外部的任务，同时按照策略放入延迟队列内。
2. manager主流程不断从队列中尝试取出mission，将他们进行更新，同时持久化保存更新过程中的所有改变（日志，任务状态，添加的资源，collection状态）



1. pinner接收外部的pinnng请求，按照开播时间放入延时队列中，
2. pinner主携程从队列中取出pinning，然后根据pinning查找collection，并尝试找到最优的collectoin。如果存在就创建任务发送给manager，不存在就再次放入队列中。



## 其他问题

### 默认pinner策略

1. 倾向于的画质：1080 > 720 > 2k > other

   对于画质而言，首选1080p，但是如果没有1080p那么很大情况下这个番剧是一个冷门番剧，使用2k来说太浪费空间，因此优先选择720。但是如果只有2k资源，为了保证资源的完整性，还是必须进行收录。

2. 倾向于汉化组：xxx>xxx>xxx

   这部分不进行默认设置，由用户来选择。

3. 倾向字幕：简体>繁体>日语，内嵌>内封>外挂

   如果字幕类型是内封，那么语言越多越好；如果类型是内嵌，那么越少越好；如果是外挂，当前情况下忽略，如果需要必须手动添加。当前阶段因为不清楚dplayer对mkv的支持度，首选内嵌字幕。

   

## 开发流程：

### Provider，Analyzer，Source开发

- [x] 调整原来的代码，拆分出公共的数据结构，并替换掉原来散落在各个其他包中的类型。
- [x] 完成定义接口

### controller，subscribe开发

- [x] controller接口完成，支持的功能思考完后形成文档。
- [x] 调整原来的worker结构，把log移动到controller中与worker同级别。
- [x] worker支持新版的subscriber
- [x] conroller通过subscriber完成日志记录功能

--- 8.10 ---

- [ ] animation支持自定义查找时关键词。
- [ ] 规划download grpc接口。
